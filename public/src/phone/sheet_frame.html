<!DOCTYPE html>
<html lang="en" ng-app="sheet">
<head>
    <link rel="stylesheet" href="/public/assets/css/bootstrap/bootstrap.min.css">
    <script src="/public/assets/js/jquery/jquery-1.11.0.js"></script>
    <script src="/public/assets/js/bootstrap/bootstrap.min.js"></script>
    <script src="/public/assets/js/angularjs/angular.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
    <meta charset="UTF-8">
    <title>__TITLE__</title>
    <meta name="viewport" content="width=device-width">
</head>
<body ng-controller="designCtrl as design" style="display: flex;flex-direction: row; font-family: 微软雅黑">
<div style="flex: 1"></div>
<div style="flex: 8; margin: 20px 0 50px 0">

    <div ng-repeat="value in design.sheet track by $index">
        <!------------------------ OUTLINE -------------------------->
        <div ng-include="'/src/design/tmpl/sub/render/paragraph.html'"></div> <!--内容-->

        <!------------------------ OUTLINE -------------------------->
        <div ng-include="'/src/design/tmpl/sub/render/single_select.html'"></div> <!--单选题-->
        <div ng-include="'/src/design/tmpl/sub/render/single_scale.html'"></div> <!--量表题-->
        <div ng-include="'/src/design/tmpl/sub/render/matrix_single_select.html'"></div> <!--矩阵单选-->
        <div ng-include="'/src/design/tmpl/sub/render/matrix_single_scale.html'"></div> <!--矩阵量表-->
        <div ng-include="'/src/design/tmpl/sub/render/pull_single_select.html'"></div> <!--下拉单选-->

        <!------------------------ OUTLINE -------------------------->
        <div ng-include="'/src/design/tmpl/sub/render/multi_select.html'"></div> <!--多选题-->
        <div ng-include="'/src/design/tmpl/sub/render/matrix_multi_select.html'"></div> <!--矩阵多选-->

        <!------------------------ OUTLINE -------------------------->
        <div ng-include="'/src/design/tmpl/sub/render/single_fill.html'"></div> <!--单项填空-->
        <div ng-include="'/src/design/tmpl/sub/render/matrix_fill.html'"></div> <!--矩阵填空-->
        <div ng-include="'/src/design/tmpl/sub/render/detail_fill.html'"></div> <!--详情填写-->
    </div>


    <!--提交按钮-->
    <div style="margin-top: 40px">
        <button ng-click="design.submitSheet()"
                style="font-family: 微软雅黑;outline: none; width: 100%; padding: 9px; font-size: 16px; border: none;border-radius: 7px;color: white; background: #4eb3eb">
            提交
        </button>
    </div>
</div>
<div style="flex: 1"></div>

<script>
    "use strict";
    let sheetModule = angular.module('sheet', []);
    sheetModule.controller('designCtrl', function ($http, $location) {
        let design = this;
        let params = $location.search();
        design.sheet = __SHEET_DATA__;
        design.config = __SHEET_CONFIG__;

        /**
         * 获取某问题的序号
         * @returns {number}
         */
        design.getQuestionnaireNum = function (index) {
            //遍历问题表单到index前的每个选项，去除所有为paragraph类型的数据
            let paraNum = 0;
            for (let i = 0; i < index; i++) {
                if (DesignDataSer.sheet[i].type == 'paragraph') {
                    paraNum++;
                }
            }
            return index - paraNum + 1; //从1开始
        };

        /**
         * 提交问卷
         */
        design.submitSheet = function () {
            let submitData = {
                openid: params.openid,
                sheetid: design.config._id,
                title: design.config.title,
                type: design.config.type,
                sheet: design.sheet,
                timestamp:new Date().getTime()
            };
            $http.post("/submitResult", submitData).success(function (response) {
                if (response == 'OK') {
                    //跳转到小程序页面指定页面
                    wx.miniProgram.navigateTo({url: '/pages/statistics/statistics'})
                }
            }).error(function (err) {
                alert("很抱歉，提交有误，请稍后重试");
            });
        };

    });
</script>
</body>
</html>