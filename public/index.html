<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://viewcoder-bucket.oss-cn-shenzhen.aliyuncs.com/cdn/js/jquery/jquery-1.11.0.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>看南网小鲜肉如何逆袭</title>
</head>
<body style="width: 100%;text-align: center;background: white; margin: 0; ">

<div style="height: 100%;">

    <!--展示页面-->
    <div id="showPage" style="">
        <!--第一页-->
        <div id="labelPage1" style="display: flex;flex-direction: row; justify-content: center; align-items: center">
            <div id="middleLocation" style="width: 0;background: orange; display: block"></div>
            <div>
                <!--占位空间-->
                <div style="width: 100%; min-height: 50px; display: inline-block"></div>
                <img id="beginBtn" style="position: relative; left: -20px;width: auto;height: auto;"
                     src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/0_1.png"/>
                <img style="width: 80%" src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/0_2.png"/>
            </div>
        </div>

        <!--牛工牛头展示-->
        <div id="labelPage2"
             style="display: flex;position: absolute; z-index: 10;visibility: hidden; bottom: 10px;width: 100%;flex-direction: column; align-items: center">
            <div style="margin-bottom: 10px">
                <img id="oxHeadBtn" style="position: relative; left: -20px"
                     src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/9_15.png"/>
                <img id="pointerBtn" style="width: 60px; height: auto; position: relative; top: -10px"
                     src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/arrow.png">
            </div>
            <img src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/9_13.png"/>
        </div>

        <!--最后一页展示  display:block转换-->
        <div id="labelPage3" style="display: none; align-items: center; justify-content: center; margin-top: 5px">
            <div id="centerMark"
                 style="display: inline-block;vertical-align: middle; width: 0; background: yellow"></div>
            <div style="position: relative;display: inline-block;vertical-align: middle">
                <img id="page3Bg_1" src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/28_3.png"/>
                <img id="page3Bg_2"
                     src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/28_3_375_547.png"/>
                <div id="createPostDiv" style="position: absolute;top: 80px;">
                    <img style="display: block;width: 60px"
                         src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/28_5.png"/>
                    <img id="createPostBtn" style="position: relative; top: -53px; left: -3px;width: 40px"
                         src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/28_14.png"/>
                </div>
            </div>
            <!--<div id="finalPageBg"-->
            <!--style="background: url(https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/28_3.png) no-repeat center center; background-size: contain"></div>-->
        </div>

        <!--视频-->
        <video id="videoContent" preload="auto"
               src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/%E4%BA%94%E5%9B%9B%E5%BA%8F%E5%88%9723.mp4"
               playsinline="true"
               webkit-playsinline="true"

               x-webkit-airplay="true"
               airplay="allow"

               x5-video-player-type="h5"
               x5-video-player-fullscreen="true"

               x5-video-orientation="portrait"
               style="position: relative; z-index: 1; display: none;width: 100%; height: 100%; object-fit: fill">
            <source src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/%E4%BA%94%E5%9B%9B%E5%BA%8F%E5%88%9723.mp4"
                    type='video/mp4'>
            your browser does not support the video tag
        </video>

        <audio id="audioContent" loop
               src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/bg_music_3.mp3">
            <source src="https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/bg_music_3.mp3"
                    type='audio/mp3'/>
        </audio>
    </div>

</div>
<script>

    $(window).load(function () {

        var screenHeight = window.innerHeight;
        var screenWidth = window.innerWidth;
        var appid = 'wx228f45c72c2feb68';

        var video = document.getElementById('videoContent');
        var audio = document.getElementById('audioContent');
        var labelPage1 = $("#labelPage1");
        var labelPage2 = $("#labelPage2");
        var labelPage3 = $("#labelPage3");
        var finalPageBg = $("#finalPageBg");
        var beginBtn = $("#beginBtn");
        var oxHeadBtn = $("#oxHeadBtn");
        var playAudio = $("#playAudio");
        var pointerBtn = $("#pointerBtn");
        var createPostBtn = $("#createPostBtn");
        var createPostDiv = $("#createPostDiv");
        $("#middleLocation").css("height", screenHeight);
        $("#centerMark").css("height", screenHeight);

        //第一页自动播放音乐
        audioAutoPlay(audio);
        //第一页动画，左右摇摆晃动
        rotateAnimate(beginBtn, -3, 3, 400);


        //记录用户信息到数据库
        //时间字段
        var date = new Date();
        var arrive_time = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + "  " + date.getHours() + ":" +
            date.getMinutes() + ":" + date.getSeconds();

        //来访方式字段
        var access_way = getUrlParameter("access_way");
        console.log('access_way', access_way);
        if (access_way != undefined && access_way != '') {
            access_way = 1;

        } else {
            access_way = 0;
        }
        var postUrl = "http://powerh5.liphin.com/enterHtmlPage";
        //var postUrl = "http://127.0.0.1:3023/enterHtmlPage";
        var userMark = '';
        $.post(postUrl, {access_way: access_way, arrive_time: arrive_time}, function (result) {
            console.log(result);
            userMark = result;
        });

        /**
         * 只适用于微信的自动播放
         */
        function audioAutoPlay(audio) {
            //指定音频播放音量
            audio.volume = 0.4;

            if (window.WeixinJSBridge) {
                WeixinJSBridge.invoke('getNetworkType', {}, function (e) {
                    audio.play();
                }, false);
            } else {
                document.addEventListener("WeixinJSBridgeReady", function () {
                    WeixinJSBridge.invoke('getNetworkType', {}, function (e) {
                        audio.play();
                    }, false);
                })
            }
            audio.play();
            return false;
        }


        /**
         * 点击开始按钮后进入视频
         */
        beginBtn.click(function () {
            //原页面取消展示
            labelPage1.css("display", "none");
            //视频页面展示
            video.style.display = "block";
            video.removeAttribute("controls");
            video.src = 'https://output-service.oss-cn-shenzhen.aliyuncs.com/powersupply/%E4%BA%94%E5%9B%9B%E5%BA%8F%E5%88%9723.mp4';
            //video.src = '/public/assets/video/movie2.mp4';
            video.load();
            video.addEventListener('loadeddata', function () {
                console.log(video.readyState);
                //视频播放
                audio.pause();
                video.play();
                monitorTime(27.5, function () {
                    //当到达27.2秒时，视频暂停，并设置牛头显示出来
                    labelPage2.css("visibility", "visible");
                    //牛头摇晃动画
                    rotateAnimate(oxHeadBtn, -3, 3, 400);
                    //指向牛头左右移动
                    translateAnimate(pointerBtn, -5, 5, 200)
                });
            });
        });


        /**
         * 牛头点击后继续播放视频操作
         */
        oxHeadBtn.click(function () {
            //牛头页面隐藏
            labelPage2.css("visibility", "hidden");
            video.play();
            monitorTime(143.7, function () {
                //显示展开第三个页面
                showPage3();
            });
        });

        //测试多种屏幕展示效果
//        labelPage1.css("display","none");
//        showPage3();

        /**
         * 解析路径生成的参数
         */
        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        }

        /**
         * 显示展开第三张页面
         */
        function showPage3() {
            //当视频播放到143.7秒时，视频页面停止，显示最后一张页面
            video.style.display = "none";
            //当手机屏幕高度大于等于660时显示第一个图片，否则显示第二个图片
            if (screenHeight >= 650) {
                $("#page3Bg_2").css("display", "none");
            } else {
                $("#page3Bg_1").css("display", "none");
            }
            //父组件显示
            labelPage3.css("display", "flex");
            //点击生成海报指引动画
            createSharePost(createPostBtn);
            //设置最后页面的width和height
            //finalPageBg.css("width", screenWidth);
            //finalPageBg.css("height", screenHeight);
            createPostDiv.css("left", (screenWidth - 60) / 2 - 5 + "px");
        }

        //当视频播放到143.7秒时，视频页面停止，显示最后一张页面
//        labelPage1.css("display","none")
//        video.style.display = "none";
//        labelPage3.css("display", "flex");
//        //点击生成海报指引动画
//        createSharePost(createPostBtn);
//        //设置最后页面的width和height
//        finalPageBg.css("width", screenWidth);
//        finalPageBg.css("height", screenHeight);
//        createPostDiv.css("left", (screenWidth - 60) /2 + "px");


        /**
         * 点击按钮生成海报页面
         */
        createPostDiv.click(function () {
            location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + appid + "&redirect_uri=http://powerh5.liphin.com/getWxUserInfo&response_type=code&scope=snsapi_userinfo&state=" + userMark + "#wechat_redirect";
        });


        /**
         * 视频播放计时器函数
         * @param targetStopTime
         * @param callback
         */
        function monitorTime(targetStopTime, callback) {
            setTimeout(function () {
                var currentTime = video.currentTime;
                //console.log(currentTime);
                //1、第一段暂停
                if (currentTime > targetStopTime) {
                    video.pause();
                    callback();

                } else {
                    monitorTime(targetStopTime, callback);
                }
            }, 100);
        }

        //左右摇晃动画
        function rotateAnimate(ele, beginDeg, endDeg, duration) {
            $({deg: beginDeg}).animate({deg: endDeg}, {
                duration: duration,
                step: function (now) {
                    ele.css({
                        transform: 'rotate(' + now + 'deg)'
                    });
                },
                complete: function () {
                    rotateAnimate(ele, endDeg, beginDeg, duration)
                }
            });
        }

        //左右移动动画
        function translateAnimate(ele, beginDeg, endDeg, duration) {
            $({deg: beginDeg}).animate({deg: endDeg}, {
                duration: duration,
                step: function (now) {
                    ele.css({
                        transform: 'translate(' + now + 'px)'
                    });
                },
                complete: function () {
                    translateAnimate(ele, endDeg, beginDeg)
                }
            });
        }

        //按钮生成分享海报动画
        function createSharePost(ele) {
            ele.css("visibility", "visible");
            setTimeout(function () {
                ele.css("visibility", "hidden");
                setTimeout(function () {
                    createSharePost(ele);
                }, 300);
            }, 500)
        }


        /************************************* 以下是微信分享设置 **********************************************************/
            //js检查调用接口是否成立
        var jsCheckResult = {};

        //初始化微信配置操作
        initWxConfig();
        var shareUrl = 'http://powerh5.liphin.com';

        /**
         * 初始化微信配置操作
         */
        function initWxConfig() {
            var url = "http://powerh5.liphin.com/jsSdkConfig?url=" + encodeURIComponent(window.location.href);
            var jsInterfaceList = [
                'updateAppMessageShareData', //分享给朋友，新版本
                'updateTimelineShareData', //分享到朋友圈，新
                'onMenuShareAppMessage', //分享给朋友，旧版本
                'onMenuShareTimeline', //分享到朋友圈，旧版本
                'checkJsApi',//检查是否可以
            ];

            //http请求获取正确的签名数据
            $.get(url, function (data, status) {

                //开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                wx.config({
                    debug: false,
                    appId: data['appid'], // 必填，公众号的唯一标识
                    timestamp: data['timestamp'], // 必填，生成签名的时间戳
                    nonceStr: data['noncestr'], // 必填，生成签名的随机串
                    signature: data['signature'],// 必填，签名
                    jsApiList: jsInterfaceList// 必填，需要使用的JS接口列表

                });

                wx.ready(function () {
                    //检测的JS接口列表
                    wx.checkJsApi({
                        //需要检测的JS接口列表，所有JS接口列表见附录2,
                        jsApiList: jsInterfaceList,
                        success: function (res) {
                            // 以键值对的形式返回，可用的api值true，不可用为false
                            // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
                            jsCheckResult = res['checkResult'];
                            //console.log(res);
                            shareToFriend();
                            shareToFriendCircle();
                        }
                    });
                });
            });
        }


        /**
         * 分享给朋友接口
         */
        function shareToFriend() {
            //根据当前客户端支持的版本调用分享接口
            if (jsCheckResult['updateAppMessageShareData']) {
                //如果支持新接口则使用新接口
                wx.updateAppMessageShareData({
                    title: '看南网小鲜肉如何逆袭成一代 “宗师”', // 分享标题
                    desc: '纪念五四运动100周年，向奋斗在各行各业一线的青年们致敬！', // 分享描述
                    link: shareUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: 'http://powerh5.liphin.com/assets/img/logo.png', // 分享图标
                    success: function () {
                        //这里是回调函数
                        //alert('函数回调 updateAppMessageShareData');
                        console.log('函数回调 updateAppMessageShareData');
                    }
                });

            } else {
                //若不支持新接口则调用旧接口发送
                wx.onMenuShareAppMessage({
                    title: '看南网小鲜肉如何逆袭成一代 “宗师”', // 分享标题
                    desc: '纪念五四运动100周年，向奋斗在各行各业一线的青年们致敬！', // 分享描述
                    link: shareUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: 'http://powerh5.liphin.com/assets/img/logo.png', // 分享图标
                    type: 'link', // 分享类型,music、video或link，不填默认为link
                    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                    trigger: function () {
                        console.log('trigger onMenuShareAppMessage');
                    },
                    success: function () {
                        // 用户点击了分享后执行的回调函数
                        //alert('函数回调 onMenuShareAppMessage');
                        console.log('函数回调 onMenuShareAppMessage');
                    },
                    fail: function () {
                        console.log('fail onMenuShareAppMessage');
                    },
                    cancel: function () {
                        console.log('cancel onMenuShareAppMessage');
                    },
                    complete: function () {
                        console.log('complete onMenuShareAppMessage');
                    }
                });
            }
        }


        /**
         * 分享到朋友圈接口
         */
        function shareToFriendCircle() {
            if (jsCheckResult['updateTimelineShareData']) {
                //如果支持新接口则使用新接口
                wx.updateTimelineShareData({
                    title: '看南网小鲜肉如何逆袭成一代 “宗师”', // 分享标题
                    link: shareUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: 'http://powerh5.liphin.com/assets/img/logo.png', // 分享图标
                    success: function () {
                        // 设置成功
                        //alert('函数回调 updateTimelineShareData');
                        console.log('函数回调 updateTimelineShareData');
                    }
                });
            } else {
                //若不支持新接口则调用旧接口发送
                wx.onMenuShareTimeline({
                    title: '看南网小鲜肉如何逆袭成一代 “宗师”', // 分享标题
                    link: shareUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: 'http://powerh5.liphin.com/assets/img/logo.png', // 分享图标
                    success: function () {
                        // 用户点击了分享后执行的回调函数
                        //alert('函数回调 onMenuShareTimeline');
                        console.log('函数回调 onMenuShareTimeline');
                    }
                });
            }
        }

    })
</script>
</body>
</html>